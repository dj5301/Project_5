---
title: "HW5"
output: github_document
---
```{r message = FALSE}
library(tidyverse)
```

# --- Birthday Paradox Simulation (no leap year, birthdays ~ Uniform{1..365}) ---

```{r}
set.seed(123)  # to replicate the result
```

# 1) single simulation：given n people，is there any same day birthday by two people? TRUE=there is at least one pair

```{r}
has_match_once <- function(n) {
  bdays <- sample.int(365, size = n, replace = TRUE)
  anyDuplicated(bdays) > 0
}
```

# 2) For n=2..50，Every n repeat 10000 times and estimate the probability
```{r}
ns <- 2:50
n_trials <- 10000
```


# use replicate() + mean() to calculate every n's probability
```{r}
prob_sim <- sapply(ns, function(n) {
  mean(replicate(n_trials, has_match_once(n)))
})
```


# 3) 可选：计算“精确理论值”用于对比（1 - 全不同的概率）
```{r}
prob_exact <- 1 - sapply(ns, function(n) {
  if (n > 365) return(0)              # 但这里最大到 50，不会触发
  prod((365:(365 - n + 1)) / 365)     # 连乘：365/365 * 364/365 * ... * (365-n+1)/365
})
```


# 4) 画图（使用 base R 或 ggplot2，二选一）
# --- base R 版本 ---
```{r}
plot(ns, prob_sim, type = "b", pch = 19, las = 1,
     xlab = "population n",
     ylab = "At least two people has same birthday",
     main = "birthday bias: estimate simulation vs theoritical value (All 365 days, Uniform distribution)")
lines(ns, prob_exact, lwd = 2, lty = 2)      # 理论曲线
legend("bottomright",
       legend = c("simulate(10000times/dot)", "Theroatical value"),
       pch = c(19, NA), lty = c(1, 2), lwd = c(1, 2), bty = "n")
```


```{r}
df <- data.frame(n = ns, sim = prob_sim, exact = prob_exact)
 ggplot(df, aes(n, sim)) +
   geom_point() + geom_line() +
   geom_line(aes(y = exact), linetype = 2) +
   labs(x = "population n", y = "At least two people has same birthday",
       title = "birthday bias: estimate simulation vs theoritical value (All 365 days, Uniform distribution)",
        subtitle = paste0("replicated n ", n_trials, " times")) +
   theme_minimal(base_size = 12)
```





```{r}
library(tidyverse)
library(broom)

set.seed(123)

# --------------------------
# Function: run simulation for a given mu
# --------------------------
sim_one_mu <- function(mu, n = 30, sigma = 5, n_sim = 5000) {
  
  replicate(n_sim, {
    x <- rnorm(n, mean = mu, sd = sigma)
    tt <- t.test(x, mu = 0)
    broom::tidy(tt) %>%
      mutate(
        mu_hat = mean(x),
        true_mu = mu
      )
  }, simplify = FALSE) %>% 
    bind_rows()
}

# --------------------------
# Run simulations: mu = 0..6
# --------------------------
mus <- 0:6

results <- map_df(mus, sim_one_mu)

head(results)

```

```{r}
power_df <- results %>%
  group_by(true_mu) %>%
  summarise(power = mean(p.value < 0.05))

ggplot(power_df, aes(x = true_mu, y = power)) +
  geom_line() +
  geom_point(size = 3) +
  labs(
    x = "True μ",
    y = "Power (P reject H0)",
    title = "Power Curve for One-Sample t-Test (n = 30, σ = 5)"
  ) +
  theme_minimal()

```

```{r}
mean_mu_df <- results %>%
  group_by(true_mu) %>%
  summarise(avg_mu_hat = mean(mu_hat))

ggplot(mean_mu_df, aes(true_mu, avg_mu_hat)) +
  geom_point(size = 3) +
  geom_line() +
  labs(
    x = "True μ",
    y = "Average μ̂ (all samples)",
    title = "Mean of μ̂ across all simulated datasets"
  ) +
  theme_minimal()

```

```{r}
mean_reject_df <- results %>%
  filter(p.value < 0.05) %>%
  group_by(true_mu) %>%
  summarise(avg_mu_hat_reject = mean(mu_hat))

ggplot(mean_reject_df, aes(true_mu, avg_mu_hat_reject)) +
  geom_point(size = 3, color = "red") +
  geom_line(color = "red") +
  labs(
    x = "True μ",
    y = "Average μ̂ | H0 rejected",
    title = "Mean of μ̂ among datasets where H0 is rejected"
  ) +
  theme_minimal()

```

```{r}
library(tidyverse)
library(broom)

# --- Load Data ---
h <- read_csv("homicide-data.csv")

# Create city_state variable
h <- h %>%
  mutate(city_state = paste(city, state, sep = "_"))

# Define "unsolved" categories
unsolved_levels <- c("Closed without arrest", "Open/No arrest")

# Summarize within each city
city_summary <- h %>%
  mutate(unsolved = disposition %in% unsolved_levels) %>%
  group_by(city_state) %>%
  summarise(
    total = n(),
    unsolved = sum(unsolved)
  )

city_summary

```

```{r}
# Filter for Baltimore
bal <- city_summary %>% filter(city_state == "Baltimore, MD")

bal_test <- prop.test(bal$unsolved, bal$total)

bal_tidy <- tidy(bal_test)

# Extract key results
bal_estimate <- bal_tidy$estimate
bal_ci_lower <- bal_tidy$conf.low
bal_ci_upper <- bal_tidy$conf.high

bal_tidy

```

```{r}
# Function to run prop.test for one row
run_test <- function(unsolved, total) {
  tidy(prop.test(unsolved, total))
}

# Apply to ALL cities
city_results <- city_summary %>%
  mutate(test = map2(unsolved, total, run_test)) %>%
  unnest(test) %>%
  select(city_state, total, unsolved, estimate, conf.low, conf.high)

city_results

```

```{r}
city_results %>%
  arrange(estimate) %>%
  mutate(city_state = factor(city_state, levels = city_state)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(
    title = "Proportion of Unsolved Homicides by City",
    x = "City",
    y = "Estimated proportion unsolved (95% CI)"
  ) +
  theme_minimal()

```

